<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</title>
    <!-- Ø¥Ø¶Ø§ÙØ© Ù…ÙƒØªØ¨Ø© QuaggaJS Ù„Ù„Ù…Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ -->
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --danger: #e74c3c;
            --dark: #2c3e50;
            --light: #ecf0f1;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background-color: var(--dark);
            color: white;
            padding: 20px 0;
            text-align: center;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
        }
        
        .form-section {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        /* Ø£Ù†Ù…Ø§Ø· Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ ÙˆØ§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ */
        #barcode-scanner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: black;
            z-index: 10000;
            display: none;
        }
        
        #barcode-scanner video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .scanner-controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
        }
        
        .camera-preview {
            width: 100%;
            max-height: 300px;
            border-radius: 8px;
            border: 2px solid #ddd;
            display: none;
        }
        
        .camera-controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: center;
        }
        
        /* Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ù†Ù…Ø§Ø· ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ */
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡</h1>
        </header>
        
        <!-- Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ) -->
        
        <!-- Ù‚Ø³Ù… Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ ÙˆØ§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
        <div class="form-section">
            <h2>Ø§Ù„Ù…Ø³Ø­ ÙˆØ§Ù„ØªØµÙˆÙŠØ±</h2>
            
            <div class="form-group">
                <label for="meterNumber" class="required">Ø±Ù‚Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯</label>
                <input type="text" id="meterNumber" required>
                
                <div class="barcode-section">
                    <button type="button" class="btn barcode-btn" id="scanBarcode">
                        ğŸ“· Ù…Ø³Ø­ Ø¨Ø§Ø±ÙƒÙˆØ¯ Ø§Ù„Ø¹Ø¯Ø§Ø¯
                    </button>
                    <p>Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù‚Ù… ÙŠØ¯ÙˆÙŠÙ‹Ø§</p>
                </div>
            </div>
            
            <!-- ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„ØµÙˆØ± -->
            <div class="form-group">
                <label>Ø§Ù„ØªØµÙˆÙŠØ± Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</label>
                <div class="camera-controls">
                    <button type="button" class="btn" id="startCamera">ğŸ“¸ ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
                    <button type="button" class="btn btn-success" id="captureImage" style="display:none;">âœ… Ø§Ù„ØªÙ‚Ø§Ø· ØµÙˆØ±Ø©</button>
                    <button type="button" class="btn btn-danger" id="stopCamera" style="display:none;">âŒ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
                </div>
                <video id="cameraPreview" class="camera-preview" autoplay playsinline></video>
                <canvas id="cameraCanvas" style="display:none;"></canvas>
                
                <select id="cameraType" class="form-group">
                    <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØµÙˆØ±Ø©</option>
                    <option value="meterImage">ØµÙˆØ±Ø© Ø§Ù„Ø¹Ø¯Ø§Ø¯</option>
                    <option value="pieceNumberImage">ØµÙˆØ±Ø© Ø±Ù‚Ù… Ø§Ù„Ù‚Ø·Ø¹Ø©</option>
                    <option value="propertyImage">ØµÙˆØ±Ø© Ø§Ù„Ø¹Ù‚Ø§Ø±</option>
                    <option value="valveImage">ØµÙˆØ±Ø© Ø§Ù„Ù…Ø­Ø¨Ø³</option>
                    <option value="boxImage">ØµÙˆØ±Ø© Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚</option>
                </select>
            </div>
        </div>

        <!-- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ ÙŠØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡Ùˆ -->

    </div>

    <!-- Ù…Ø§Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ -->
    <div id="barcode-scanner">
        <video id="barcode-video"></video>
        <div class="scanner-controls">
            <button class="btn btn-danger" id="closeScanner">âŒ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø§Ø³Ø­</button>
        </div>
    </div>

    <script>
        // Ø±Ø§Ø¨Ø· Google Apps Script
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwwFU0ryfFr1d4krBnzEodqO3enAEPt7YtLEbkax3_b9AleKVP8WtguwOb2swwyhqIi/exec';

        // Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØ§Ù„Ù…Ø§Ø³Ø­
        const barcodeScanner = document.getElementById('barcode-scanner');
        const barcodeVideo = document.getElementById('barcode-video');
        const closeScanner = document.getElementById('closeScanner');
        const scanBarcodeBtn = document.getElementById('scanBarcode');
        
        const cameraPreview = document.getElementById('cameraPreview');
        const cameraCanvas = document.getElementById('cameraCanvas');
        const startCameraBtn = document.getElementById('startCamera');
        const captureImageBtn = document.getElementById('captureImage');
        const stopCameraBtn = document.getElementById('stopCamera');
        const cameraTypeSelect = document.getElementById('cameraType');

        let stream = null;
        let currentCameraType = '';

        // Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ø¹ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©
        scanBarcodeBtn.addEventListener('click', function() {
            startBarcodeScanner();
        });

        closeScanner.addEventListener('click', function() {
            stopBarcodeScanner();
        });

        // Ø¨Ø¯Ø¡ Ù…Ø§Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
        function startBarcodeScanner() {
            barcodeScanner.style.display = 'block';
            
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1280 },
                    height: { ideal: 720 }
                } 
            }).then(function(mediaStream) {
                barcodeVideo.srcObject = mediaStream;
                barcodeVideo.play();
                
                // ØªÙ‡ÙŠØ¦Ø© QuaggaJS Ù„Ù„Ù…Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: barcodeVideo,
                        constraints: {
                            width: 1280,
                            height: 720,
                            facingMode: "environment"
                        }
                    },
                    decoder: {
                        readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader"]
                    }
                }, function(err) {
                    if (err) {
                        console.error('Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø§Ø³Ø­:', err);
                        return;
                    }
                    Quagga.start();
                });

                Quagga.onDetected(function(result) {
                    const code = result.codeResult.code;
                    document.getElementById('meterNumber').value = code;
                    showMessage('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯: ' + code, 'success');
                    stopBarcodeScanner();
                });

            }).catch(function(error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§:', error);
                showMessage('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + error.message, 'error');
            });
        }

        // Ø¥ÙŠÙ‚Ø§Ù Ù…Ø§Ø³Ø­ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯
        function stopBarcodeScanner() {
            if (barcodeVideo.srcObject) {
                barcodeVideo.srcObject.getTracks().forEach(track => track.stop());
            }
            Quagga.stop();
            barcodeScanner.style.display = 'none';
        }

        // Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„ØªØµÙˆÙŠØ±
        startCameraBtn.addEventListener('click', function() {
            currentCameraType = cameraTypeSelect.value;
            if (!currentCameraType) {
                showMessage('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø£ÙˆÙ„Ø§Ù‹', 'error');
                return;
            }
            startCamera();
        });

        captureImageBtn.addEventListener('click', captureImage);
        stopCameraBtn.addEventListener('click', stopCamera);

        function startCamera() {
            navigator.mediaDevices.getUserMedia({ 
                video: { 
                    facingMode: 'environment',
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                } 
            }).then(function(mediaStream) {
                stream = mediaStream;
                cameraPreview.srcObject = stream;
                cameraPreview.style.display = 'block';
                startCameraBtn.style.display = 'none';
                captureImageBtn.style.display = 'inline-block';
                stopCameraBtn.style.display = 'inline-block';
            }).catch(function(error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:', error);
                showMessage('Ø®Ø·Ø£ ÙÙŠ ÙØªØ­ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§: ' + error.message, 'error');
            });
        }

        function captureImage() {
            const context = cameraCanvas.getContext('2d');
            cameraCanvas.width = cameraPreview.videoWidth;
            cameraCanvas.height = cameraPreview.videoHeight;
            context.drawImage(cameraPreview, 0, 0);
            
            // ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ base64
            const imageData = cameraCanvas.toDataURL('image/jpeg', 0.8);
            
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
            const fileInput = document.getElementById(currentCameraType);
            const previewContainer = document.getElementById(currentCameraType + 'PreviewContainer');
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„ØµÙˆØ±Ø©
            const previewDiv = document.createElement('div');
            previewDiv.className = 'image-preview-container';
            
            const img = document.createElement('img');
            img.src = imageData;
            img.className = 'preview-image';
            
            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-image';
            removeBtn.innerHTML = 'Ã—';
            removeBtn.onclick = function() {
                previewContainer.removeChild(previewDiv);
                fileInput.value = '';
            };
            
            previewDiv.appendChild(img);
            previewDiv.appendChild(removeBtn);
            previewContainer.innerHTML = '';
            previewContainer.appendChild(previewDiv);
            
            // Ø­ÙØ¸ Ø§Ù„ØµÙˆØ±Ø© ÙÙŠ input file (Ù…Ø­Ø§ÙƒØ§Ø©)
            const blob = dataURLtoBlob(imageData);
            const file = new File([blob], currentCameraType + '.jpg', { type: 'image/jpeg' });
            const dataTransfer = new DataTransfer();
            dataTransfer.items.add(file);
            fileInput.files = dataTransfer.files;
            
            showMessage('ØªÙ… Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
            stopCamera();
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            cameraPreview.style.display = 'none';
            startCameraBtn.style.display = 'inline-block';
            captureImageBtn.style.display = 'none';
            stopCameraBtn.style.display = 'none';
        }

        function dataURLtoBlob(dataURL) {
            const parts = dataURL.split(';base64,');
            const contentType = parts[0].split(':')[1];
            const raw = window.atob(parts[1]);
            const uInt8Array = new Uint8Array(raw.length);
            
            for (let i = 0; i < raw.length; ++i) {
                uInt8Array[i] = raw.charCodeAt(i);
            }
            
            return new Blob([uInt8Array], { type: contentType });
        }

        // Ø¯Ø§Ù„Ø© Ø§Ù„ØªØµØ­ÙŠØ­
        function debugLog(message) {
            console.log(message);
            const debugDiv = document.getElementById('debugConsole') || createDebugConsole();
            debugDiv.innerHTML += '<div style="border-bottom:1px solid #333; padding:5px;">' + 
                                new Date().toLocaleTimeString() + ': ' + message + '</div>';
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }

        function createDebugConsole() {
            const debugDiv = document.createElement('div');
            debugDiv.id = 'debugConsole';
            debugDiv.style.cssText = 'position:fixed; bottom:0; left:0; right:0; height:200px; background:#000; color:#0f0; padding:10px; overflow:auto; z-index:10000; font-family:monospace; font-size:12px; border-top:2px solid #0f0;';
            debugDiv.innerHTML = '<h4 style="color:#fff; margin:0 0 10px 0; text-align:center;">ØªØµØ­ÙŠØ­ Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ - Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª</h4>';
            document.body.appendChild(debugDiv);
            return debugDiv;
        }

        // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø¯Ù…Ø©
        async function testConnection() {
            try {
                debugLog('ğŸ”— Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø¯Ù…Ø©...');
                const response = await fetch(GOOGLE_SCRIPT_URL);
                const result = await response.json();
                debugLog('âœ… Ø§ØªØµØ§Ù„ Ù†Ø§Ø¬Ø­: ' + result.message);
                return true;
            } catch (error) {
                debugLog('âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: ' + error.message);
                return false;
            }
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        document.addEventListener('DOMContentLoaded', function() {
            testConnection();
            showMessage('ğŸ‘‹ Ù…Ø±Ø­Ø¨Ø§Ù‹! Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…', 'success');
        });

        // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¯ÙˆØ§Ù„ ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ...
    </script>
</body>
</html>
